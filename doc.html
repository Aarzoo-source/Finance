<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Centroid Solutions</title>
<style>
  body {
    font-family: 'Andalus', Arial, sans-serif;
    font-size: 18px;
    max-width: 900px;
    margin: auto;
    padding: 1rem;
    background-color: #f9f9f9;
  }
  h1 {
    text-align: center;
  }
  .timer {
    font-size: 1.5rem;
    margin-bottom: 1rem;
    text-align: center;
  }
  .warning {
    color: red;
    font-weight: bold;
    text-align: center;
    margin: 1rem 0;
  }
  /* Container for question and navigation */
  .test-container {
    display: flex;
    justify-content: space-between;
  }
  /* Left side: question and answer */
  .question-area {
    width: 60%;
  }
  .question-text {
    background-color: rgb(108, 195, 224);
    padding: 10px 15px;
    border-radius: 10px;
    font-weight: bold;
    color: #000;
    height: 1cm;
    margin-bottom: 8px;
  }
  textarea, select {
    background-color: #fff;
    border: 1px solid #ccc;
    border-radius: 5px;
    font-size: 18px;
    font-family: 'Andalus', Arial, sans-serif;
    width: 16cm;
  }
  textarea {
    height: 3cm;
  }
  /* For dropdown, match question height */
  select {
    height: 1cm;
  }
  /* Hide all questions by default */
  .question-container {
    display: none;
  }
  /* Show only active question */
  .question-container.active {
    display: block;
  }
  /* Right side: navigation buttons */
  .nav-area {
    width: 30%;
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    gap: 10px;
    align-items: flex-end;
  }
  button {
    background-color: rgb(108, 195, 224);
    border: none;
    color: white;
    padding: 10px 20px;
    font-size: 1.2rem;
    border-radius: 8px;
    cursor: pointer;
    width: 120px;
  }
  button:disabled {
    background-color: #bbb;
    cursor: not-allowed;
  }
  #camera {
    display: block;
    margin: 1rem auto;
    border: 1px solid #ccc;
  }
  #photos {
    margin-top: 1rem;
    font-size: 0.9rem;
    text-align: center;
  }
</style>
</head>
<body>

<h1>Centroid Solutions</h1>
<div class="timer" id="timer">Time Left: 05:00</div>
<div class="warning" id="warning" style="display:none;"></div>

<form id="testForm" class="test-container">

  <div class="question-area">
    <div class="question-container active" data-index="0">
      <div class="question-text">1. What is the primary function of the Federal Reserve?</div>
      <textarea id="q1" rows="5" required></textarea>
    </div>

    <div class="question-container" data-index="1">
      <div class="question-text">2. Which financial statement shows a company's assets and liabilities?</div>
      <select id="q2" required>
        <option value="" disabled selected>Select an option</option>
        <option value="Income Statement">Income Statement</option>
        <option value="Balance Sheet">Balance Sheet</option>
        <option value="Cash Flow Statement">Cash Flow Statement</option>
      </select>
    </div>

    <div class="question-container" data-index="2">
      <div class="question-text">3. Explain the difference between a stock and a bond.</div>
      <textarea id="q3" rows="5" required></textarea>
    </div>
  </div>

  <div class="nav-area">
    <button type="button" id="prevBtn" disabled>Previous</button>
    <button type="button" id="nextBtn">Next</button>
  </div>

</form>

<video id="camera" width="320" height="240" autoplay muted></video>
<div id="photos"></div>

<script>
(() => {
  const testDurationSec = 300; // 5 minutes
  let timeLeft = testDurationSec;
  const timerEl = document.getElementById('timer');
  const warningEl = document.getElementById('warning');
  const form = document.getElementById('testForm');
  const camera = document.getElementById('camera');
  const photosEl = document.getElementById('photos');

  let snapshots = [];
  let snapshotIntervalId = null;
  let timerIntervalId = null;
  let testSubmitted = false;

  // Navigation logic
  const questions = document.querySelectorAll('.question-container');
  let currentQuestionIndex = 0;
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');

  function showQuestion(index) {
    questions.forEach((q, i) => {
      q.classList.toggle('active', i === index);
    });
    currentQuestionIndex = index;
    prevBtn.disabled = index === 0;
    // Change Next to Submit on last question
    if(index === questions.length -1) {
      nextBtn.textContent = 'Submit';
    } else {
      nextBtn.textContent = 'Next';
    }
  }

  prevBtn.addEventListener('click', () => {
    if (testSubmitted) return;
    if(currentQuestionIndex > 0) {
      showQuestion(currentQuestionIndex -1);
    }
  });

  nextBtn.addEventListener('click', () => {
    if (testSubmitted) return;

    // Check if current question is filled
    const currentQuestion = questions[currentQuestionIndex];
    const input = currentQuestion.querySelector('textarea, select');
    if (!input.checkValidity()) {
      input.reportValidity();
      return;
    }

    if(currentQuestionIndex === questions.length -1) {
      submitTest('Manual submission');
    } else {
      showQuestion(currentQuestionIndex +1);
    }
  });

  async function startCamera() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      camera.srcObject = stream;
    } catch (err) {
      alert('Camera access is required to take snapshots during the test.');
      console.error(err);
    }
  }

  function takeSnapshot() {
    if (!camera.srcObject) return;

    const canvas = document.createElement('canvas');
    canvas.width = camera.videoWidth || 320;
    canvas.height = camera.videoHeight || 240;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(camera, 0, 0, canvas.width, canvas.height);
    const imageData = canvas.toDataURL('image/png');
    const timestamp = new Date().toISOString();
    snapshots.push({ timestamp, imageData });
    photosEl.textContent = `Snapshots taken: ${snapshots.length}`;
  }

  function updateTimer() {
    const minutes = String(Math.floor(timeLeft / 60)).padStart(2,'0');
    const seconds = String(timeLeft % 60).padStart(2,'0');
    timerEl.textContent = `Time Left: ${minutes}:${seconds}`;
  }

  function submitTest(reason) {
    if (testSubmitted) return;
    testSubmitted = true;

    clearInterval(timerIntervalId);
    clearInterval(snapshotIntervalId);

    warningEl.style.display = 'block';
    warningEl.textContent = reason ? `Test submitted automatically: ${reason}` : 'Test submitted successfully!';

    const answers = {
      submittedAt: new Date().toISOString(),
      reason: reason || 'Manual submit',
      answers: {
        q1: form.q1.value.trim(),
        q2: form.q2.value,
        q3: form.q3.value.trim()
      },
      snapshots
    };

    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(answers, null, 2));
    const dlAnchorElem = document.createElement('a');
    dlAnchorElem.setAttribute("href", dataStr);
    const fileName = `centroid_test_${new Date().toISOString().replace(/[:.]/g, '-')}.json`;
    dlAnchorElem.setAttribute("download", fileName);
    document.body.appendChild(dlAnchorElem);
    dlAnchorElem.click();
    dlAnchorElem.remove();

    form.querySelectorAll('textarea, select, button').forEach(el => el.disabled = true);
  }

  document.addEventListener('visibilitychange', () => {
    if (document.hidden && !testSubmitted) {
      submitTest('Tab/window switch detected');
    }
  });

  function startTimer() {
    updateTimer();
    timerIntervalId = setInterval(() => {
      timeLeft--;
      updateTimer();
      if (timeLeft <= 0) {
        submitTest('Time is up');
      }
    }, 1000);
  }

  function startSnapshots() {
    takeSnapshot();
    snapshotIntervalId = setInterval(() => {
      takeSnapshot();
    }, 60000);
  }

  // Initialize
  startCamera();
  startTimer();
  startSnapshots();
  showQuestion(0);
})();
</script>

</body>
</html>
